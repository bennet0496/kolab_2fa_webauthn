window.rcmail&&rcmail.addEventListener("init",function(){function a(){return Math.round(new Date().getTime()/1e3)}function b(){const a=$("#kolab2fa-factors tbody");a.html("");let b=0;$.each(rcmail.env.kolab_2fa_factors,function(c,d){if(d.active){const e=$("<tr>").addClass(d.method).appendTo(a),f=$("<a class=\"button icon delete\">").attr({href:"#",rel:c}).append($("<span class=\"inner\">").text(rcmail.get_label("remove","kolab_2fa")));$("<td>").addClass("name").text(d.label||d.name).appendTo(e),$("<td>").addClass("created").text(d.created||"??").appendTo(e),$("<td>").addClass("actions buttons-cell").append(f).appendTo(e),b++}}),a.parent()[0<b?"show":"hide"]()}function c(b){let c,d=$("#kolab2fa-prop-"+b),f=rcmail.env.kolab_2fa_factors[b];rcmail.triggerEvent("kolab2fa_add_factor",{method:b}),d.length&&(d.get(0).reset(),d.find("img.qrcode").attr("src","data:image/gif;base64,R0lGODlhDwAPAIAAAMDAwAAAACH5BAEAAAAALAAAAAAPAA8AQAINhI+py+0Po5y02otnAQA7"),d.off("submit"),j=rcmail.show_popup_dialog(d.show(),rcmail.get_label("addfactor","kolab_2fa"),[{text:rcmail.gettext("save","kolab_2fa"),class:"mainaction save",click:function(){e(b)}},{text:rcmail.gettext("cancel"),class:"cancel",click:function(){j.dialog("destroy"),window.location.reload()}}],{open:function(a){$(a.target).find("input[name=\"_verify_code\"]").keypress(function(a){13===a.which&&$(a.target).closest(".ui-dialog").find("button.mainaction").click()})},close:function(){d.hide().appendTo(document.body),j=null},height:"totp"===b||"htop"===b?500:160}).data("method",b).data("timestamp",a()),d.on("submit",function(){return e(b),!1}),c=rcmail.set_busy(!0,"loading"),rcmail.http_post("plugin.kolab-2fa-data",{_method:b},c))}function d(a){const b=rcmail.set_busy(!0,"saving");rcmail.http_post("plugin.kolab-2fa-save",{_method:a,_data:"false"},b)}function e(a){let b,c,d=$("#kolab2fa-prop-"+a),e=d.find("input[name=\"_verify_code\"]");return e.length&&!e.val().length?(alert(rcmail.get_label("verifycodemissing","kolab_2fa")),e.select(),!1):void(c=f(d),b=rcmail.set_busy(!0,"saving"),rcmail.http_post("plugin.kolab-2fa-save",{_method:c.id||a,_data:JSON.stringify(c),_verify_code:e.val(),_timestamp:j?j.data("timestamp"):null},b))}function f(a){const b={};return a.find("input, select").each(function(a,c){if(console.log(c),0===c.name.indexOf("_prop")){console.log("prop");const a=c.name.match(/\[([a-z0-9_.-]+)]$/i);1<a?.length&&(console.log(a),b[a[1]]="SELECT"===c.tagName?$("option:selected",c).val():$(c).val())}}),b}function g(b,c){if(!0!==rcmail.env.session_secured&&rcmail.env.session_secured<a()-180){let d,e;if($.each(rcmail.env.kolab_2fa_factors,function(a,b){if((b.active&&!d||d===c)&&(d=a,e=b.label||b.name,!c||a!==c))return!0}),d){h.push(b);const c=document.querySelector("#kolab2fa-highsecuritydialog");return i=rcmail.show_popup_dialog(c.content.cloneNode(!0),rcmail.get_label("highsecurityrequired","kolab_2fa"),[{text:rcmail.gettext("enterhighsecurity","kolab_2fa"),click:function(a){console.log("submit highsec form from button:",a,a.target),document.querySelector("#highsec-form").requestSubmit()},class:"mainaction save"},{text:rcmail.gettext("cancel"),class:"cancel",click:function(){i.dialog("destory"),window.location.reload()}}],{open:function(a,b){console.log("opening highsec form ",a,b),$(a.target).find("form table tr").each(function(){const a=$("input,select",this),b=$("label",this),c=a.data("icon"),d=$("<i>").attr("class","input-group-text icon "+a.attr("name").replace("_",""));c&&d.addClass(c),$(this).addClass("form-group row"),b.parent().css("display","none"),a.addClass(a.is("select")?"custom-select":"form-control").attr("placeholder",b.text()).keypress(function(a){13===a.which&&(console.log("submit highsec form from enter-key",a,a.target),document.querySelector("#highsec-form").requestSubmit())}).before($("<span class=\"input-group-prepend\">").append(d)).parent().addClass("input-group input-group-lg")}),rcmail.triggerEvent("kolab2fa_style_elements",{form:$("#highsec-form")}),document.querySelector("#highsec-form").addEventListener("submit",function(a){a.preventDefault(),console.log("#highsec-form submit",a);let b=Array.from(a.currentTarget.elements).reduce(function(c,a){return["_task","_action"].includes(a.name)||(c[a.name]=a.value),c},{});console.log(b);let c=rcmail.set_busy(!0,"verifying");return rcmail.http_post("plugin.kolab-2fa-verify",{...b,_session:1,_timestamp:i.data("timestamp")},c),!1}),$(a.target).closest("input.kolab2facode").keypress(function(a){13===a.which&&$(a.target).closest(".ui-dialog").find("button.mainaction").click()}).select()},close:function(){$(this).remove(),i=null,h.pop()}}).data("timestamp",a()),!1}}b.call(this)}const h=[];let i,j;rcmail.env.kolab_2fa_factors||(rcmail.env.kolab_2fa_factors={}),rcmail.addEventListener("plugin.render_data",function(a){const b=a.method,c=$("#kolab2fa-prop-"+b);console.log(a),rcmail.triggerEvent("kolab2fa_render_data",{data:a,form:c}),c.length?($.each(a,function(a,b){c.find("[name=\"_prop["+a+"]\"]").val(b)}),a.qrcode&&$("img.qrcode[rel="+b+"]").attr("src","data:image/png;base64,"+a.qrcode)):window.console&&console.error("Cannot assign auth data",a)}),rcmail.addEventListener("plugin.save_success",function(a){!a.active&&rcmail.env.kolab_2fa_factors[a.id]?delete rcmail.env.kolab_2fa_factors[a.id]:rcmail.env.kolab_2fa_factors[a.id]?$.extend(rcmail.env.kolab_2fa_factors[a.id],a):rcmail.env.kolab_2fa_factors[a.id]=a,j&&j.dialog("destroy"),window.location.reload()}),rcmail.addEventListener("plugin.verify_response",function(b){if(b.success&&i&&i.is(":visible")){for(let a;h.length;)a=h.pop(),a();console.log("closing high sec form"),i.dialog("destroy"),rcmail.env.session_secured=a()}else rcmail.display_message(b.message,b.success?"confirmation":"warning"),i&&i.is(":visible")?i.find("input[name=\"_code\"]").val("").select():$("#kolab2fa-prop-"+b.method+" input.k2fa-verify").val("").select()}),rcmail.addEventListener("plugin.reset_form",function(a){a&&rcmail.env.kolab_2fa_factors[a]&&(rcmail.env.kolab_2fa_factors[a].active=!1),b()}),$("#kolab2fa-add").change(function(){const a=$("option:selected",this).val();g(function(){c(a)}),this.selectedIndex=0}),$("#kolab2fa-factors tbody").on("click",".button.delete",function(){const a=$(this).attr("rel");return g(function(){confirm(rcmail.get_label("authremoveconfirm","kolab_2fa"))&&d(a)},a),!1}),$(".propform input.k2fa-verify").keypress(function(a){13===a.which&&$(this).closest(".propform").find(".button.verify").click()}),b()});