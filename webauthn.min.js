const{startRegistration,startAuthentication}=SimpleWebAuthnBrowser;window.rcmail&&rcmail.addEventListener("kolab2fa_render_data",async a=>{if(console.log("kolab2fa_rander_data",a),"webauthn"===a.data.method){const b=JSON.parse(a?.data.registration_options);let c;try{c=await startRegistration({optionsJSON:b})}catch(a){console.log(a);const b=document.createElement("span");return b.style.textAlign="left",b.innerText=a,document.querySelector(".ui-dialog-content").replaceChildren(b),void document.querySelector(".mainaction").remove()}if(console.log(c),a.form.length){let b=document.createElement("input");b.type="hidden",b.name="_prop[creation_response]",b.value=JSON.stringify(c),a.form.get(0).appendChild(b)}}}),window.rcmail&&rcmail.addEventListener("kolab2fa_style_elements",async a=>{const b=document.querySelector("#rcmlogin2fawebauthn");if(!b)return;const c=b.attributes.getNamedItem("name")?.value,d=b.attributes.getNamedItem("placeholder")?.value,e=b.attributes.getNamedItem("aria-auth-options")?.value;console.log(atob(e));const f=document.createElement("button");f.type="button",f.className="kolab2facode button mainaction btn btn-primary form-control",f.id="rcmlogin2fawebauthnbutton",f.setAttribute("aria-auth-options",e),f.innerText=d,f.addEventListener("click",async b=>{const c=b.target.attributes.getNamedItem("aria-auth-options")?.value,d=JSON.parse(atob(c));console.log(d);let e;try{e=await startAuthentication({optionsJSON:d})}catch(a){console.log(a,a.name);const b=document.createElement("span");b.style.textAlign="left",b.innerText=a;const c=document.createElement("a");return c.innerText=rcmail.get_label("again","kolab_2fa"),c.href="#",c.style={marginTop:"1.3rem",textDecoration:"underline",cursor:"pointer"},c.addEventListener("click",()=>window.location.reload()),void document.querySelector("#login-form").replaceChildren(b,document.createElement("br"),c)}console.log(e,a.form),document.querySelector("#rcmlogin2fawebauthn").value=JSON.stringify(e),document.querySelector("#rcmlogin2fawebauthn").form.requestSubmit()});const g=document.createElement("input");g.type="hidden",g.name=c,g.id="rcmlogin2fawebauthn",b.parentElement.replaceChildren(f,g),document.querySelector("#rcmlogin2fawebauthn").parentElement.classList.replace("input-group","w-100")||document.querySelector("#rcmlogin2fawebauthn").parentElement.classList.add("w-100")}),window.rcmail&&rcmail.addEventListener("init",async()=>{"login"===rcmail.env.task&&rcmail.triggerEvent("kolab2fa_style_elements",{form:$("#login-form")})});